<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Product Showcase</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Jost:wght@300;400;500;600&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ===================== CSS VARIABLES ===================== */
:root {
  --page-bg: #f7f4ef;
  --card-bg: #ffffff;
  --text-color: #3d2b1a;
  --accent-color: #c8a97e;
  --deep-color: #1a0f05;
  --btn-bg: #3d2b1a;
  --btn-text: #f7f4ef;
  --btn-hover-bg: #c8a97e;
  --btn-hover-text: #1a0f05;
  --footer-bg: #3d2b1a;
  --footer-text: #f7f4ef;
  --display-font: 'Playfair Display', serif;
  --body-font: 'Jost', sans-serif;
  --title-size: 1.05rem;
  --desc-size: 0.875rem;
  --desc-clamp: 2;
  --columns: 3;
  --gap: 1.5rem;
  --card-radius: 4px;
  --aspect-ratio: 1/1;
  --footer-font-size: 0.875rem;
  --admin-w: 380px;
}

/* ===================== RESET ===================== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body {
  font-family: var(--body-font);
  background: var(--page-bg);
  color: var(--text-color);
  transition: background 0.3s, color 0.3s;
  min-height: 100vh;
}

/* ===================== HEADER ===================== */
#site-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1.25rem 2rem;
  border-bottom: 1px solid color-mix(in srgb, var(--accent-color) 30%, transparent);
  position: sticky;
  top: 0;
  z-index: 100;
  background: var(--page-bg);
  backdrop-filter: blur(8px);
}
#store-name-display {
  font-family: var(--display-font);
  font-size: 1.35rem;
  color: var(--deep-color);
  letter-spacing: 0.02em;
}
.header-actions {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}
.view-toggle {
  display: flex;
  gap: 0.25rem;
  background: color-mix(in srgb, var(--text-color) 8%, transparent);
  border-radius: 6px;
  padding: 3px;
}
.view-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 0.3rem 0.5rem;
  border-radius: 4px;
  color: var(--text-color);
  font-size: 1rem;
  opacity: 0.5;
  transition: all 0.2s;
}
.view-btn.active { background: var(--accent-color); color: var(--deep-color); opacity: 1; }

/* ===================== HERO ===================== */
#hero {
  text-align: center;
  padding: 3.5rem 2rem 2rem;
}
#hero-title-display {
  font-family: var(--display-font);
  font-size: clamp(2rem, 5vw, 3.5rem);
  color: var(--deep-color);
  line-height: 1.15;
  margin-bottom: 0.5rem;
}
#hero-sub-display {
  font-size: 1rem;
  opacity: 0.65;
  letter-spacing: 0.04em;
}

/* ===================== DROP ZONE ===================== */
#dropzone-wrap {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 2rem;
  min-height: 60vh;
}
#dropzone {
  border: 2px dashed color-mix(in srgb, var(--accent-color) 60%, transparent);
  border-radius: calc(var(--card-radius) * 3px);
  padding: 4rem 3rem;
  text-align: center;
  cursor: pointer;
  transition: all 0.25s;
  max-width: 480px;
  width: 100%;
}
#dropzone:hover, #dropzone.drag-over {
  border-color: var(--accent-color);
  background: color-mix(in srgb, var(--accent-color) 8%, transparent);
  transform: scale(1.01);
}
.drop-icon { font-size: 3rem; margin-bottom: 1rem; display: block; }
.drop-title {
  font-family: var(--display-font);
  font-size: 1.4rem;
  color: var(--deep-color);
  margin-bottom: 0.5rem;
}
.drop-sub { font-size: 0.875rem; opacity: 0.6; }

#reload-notice {
  display: none;
  margin-top: 1.5rem;
  padding: 1rem 1.5rem;
  background: color-mix(in srgb, var(--accent-color) 15%, transparent);
  border: 1px solid color-mix(in srgb, var(--accent-color) 40%, transparent);
  border-radius: 8px;
  text-align: center;
  max-width: 480px;
  width: 100%;
}
#reload-notice p { font-size: 0.875rem; margin-bottom: 0.75rem; }
#reload-notice button {
  background: var(--btn-bg);
  color: var(--btn-text);
  border: none;
  padding: 0.5rem 1.25rem;
  border-radius: 4px;
  cursor: pointer;
  font-family: var(--body-font);
  font-size: 0.875rem;
  transition: all 0.2s;
}
#reload-notice button:hover { background: var(--btn-hover-bg); color: var(--btn-hover-text); }

/* ===================== MAIN CONTENT ===================== */
#main-content { display: none; padding: 1.5rem 2rem 3rem; }

/* ===================== PRODUCT GRID ===================== */
.product-grid {
  display: grid;
  grid-template-columns: repeat(var(--columns), 1fr);
  gap: var(--gap);
}
@media (max-width: 900px) { .product-grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 540px) { .product-grid { grid-template-columns: 1fr; } }

.product-list {
  display: flex;
  flex-direction: column;
  gap: var(--gap);
}

/* ===================== PRODUCT CARD ===================== */
.product-card {
  background: var(--card-bg);
  border-radius: var(--card-radius);
  overflow: hidden;
  cursor: pointer;
  transition: transform 0.25s, box-shadow 0.25s;
  animation: cardEntrance 0.45s both;
  box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}
@keyframes cardEntrance {
  from { opacity: 0; transform: translateY(16px); }
  to { opacity: 1; transform: translateY(0); }
}
.product-card:hover {
  transform: translateY(-4px) scale(1.01);
  box-shadow: 0 12px 32px rgba(0,0,0,0.12);
}
.card-img-wrap {
  aspect-ratio: var(--aspect-ratio);
  overflow: hidden;
  background: color-mix(in srgb, var(--accent-color) 10%, var(--page-bg));
}
.card-img-wrap img {
  width: 100%; height: 100%;
  object-fit: cover;
  transition: transform 0.4s;
}
.product-card:hover .card-img-wrap img { transform: scale(1.07); }
.card-body { padding: 1rem; }
.card-title {
  font-family: var(--display-font);
  font-size: var(--title-size);
  color: var(--deep-color);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 0.3rem;
}
.card-price {
  color: var(--accent-color);
  font-weight: 600;
  font-size: 0.95rem;
  margin-bottom: 0.4rem;
}
.card-desc {
  font-size: var(--desc-size);
  line-height: 1.6;
  color: var(--text-color);
  opacity: 0.8;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: var(--desc-clamp);
  -webkit-box-orient: vertical;
}
.card-extra-field {
  font-size: 0.78rem;
  margin-top: 0.3rem;
  opacity: 0.7;
}
.field-key { color: var(--accent-color); font-weight: 600; margin-right: 0.3rem; text-transform: capitalize; }

/* List card */
.card-list-img {
  width: 160px;
  flex-shrink: 0;
  overflow: hidden;
  background: color-mix(in srgb, var(--accent-color) 10%, var(--page-bg));
}
.card-list-img img { width: 100%; height: 100%; object-fit: cover; }
.product-card.product-list > * { display: flex; }
.product-list .product-card {
  display: flex;
  flex-direction: row;
}
.card-list-body { padding: 1.25rem; flex: 1; }

/* ===================== EMPTY STATE ===================== */
.empty-state {
  grid-column: 1/-1;
  text-align: center;
  padding: 5rem 2rem;
  opacity: 0.5;
}
.empty-icon { font-size: 3rem; margin-bottom: 1rem; }

/* ===================== PAGINATION ===================== */
#pagination {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.4rem;
  margin-top: 2.5rem;
  flex-wrap: wrap;
}
.page-btn {
  background: none;
  border: 1px solid color-mix(in srgb, var(--accent-color) 40%, transparent);
  color: var(--text-color);
  border-radius: 4px;
  padding: 0.4rem 0.75rem;
  cursor: pointer;
  font-family: var(--body-font);
  font-size: 0.875rem;
  transition: all 0.2s;
}
.page-btn:hover:not(:disabled) { background: var(--accent-color); color: var(--deep-color); border-color: var(--accent-color); }
.page-btn--active { background: var(--btn-bg); color: var(--btn-text); border-color: var(--btn-bg); }
.page-btn:disabled { opacity: 0.3; cursor: default; }
.page-dots { padding: 0.4rem 0.25rem; opacity: 0.5; font-size: 0.875rem; }

/* ===================== MODAL ===================== */
#modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 500;
  overflow-y: auto;
  backdrop-filter: blur(4px);
  /* use flex column so short modals are top-centered, tall ones scroll */
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 3vh 1rem;
}
#modal-overlay.modal-visible { display: flex; }
#modal-box {
  background: var(--card-bg);
  border-radius: 8px;
  display: flex;
  overflow: hidden;
  position: relative;
  /* width and max-width set by JS from theme.modalWidth */
  width: 100%;
  transform: scale(0.9);
  opacity: 0;
  transition: transform 0.25s, opacity 0.25s;
  flex-shrink: 0;
  /* align-self centers in the flex column */
  align-self: center;
}
#modal-box.modal-box--open { transform: scale(1); opacity: 1; }
.modal-close {
  position: absolute;
  top: 0.75rem; right: 0.75rem;
  width: 32px; height: 32px;
  border-radius: 50%;
  background: var(--btn-bg);
  color: var(--btn-text);
  border: none;
  font-size: 1.1rem;
  cursor: pointer;
  z-index: 10;
  display: flex; align-items: center; justify-content: center;
  transition: background 0.2s;
}
.modal-close:hover { background: var(--accent-color); color: var(--deep-color); }
.modal-img-wrap { overflow: hidden; background: color-mix(in srgb, var(--accent-color) 8%, var(--page-bg)); min-height: 200px; }

/* ===================== CONTACT FOOTER ===================== */
#contact-footer {
  display: none;
  background: var(--footer-bg);
  color: var(--footer-text);
  text-align: center;
  padding: 1rem 2rem;
  font-size: var(--footer-font-size);
  gap: 0.5rem;
  flex-wrap: wrap;
  align-items: center;
  justify-content: center;
}
#contact-footer.footer-visible { display: flex; }
#contact-footer a {
  color: var(--footer-text);
  text-decoration: none;
  opacity: 0.85;
  transition: opacity 0.2s;
}
#contact-footer a:hover { opacity: 1; text-decoration: underline; }
.footer-sep { opacity: 0.4; }
#footer-tagline { opacity: 0.6; margin-right: 0.5rem; }

/* ===================== EXPLAINER OVERLAY ===================== */
#explainer-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: var(--page-bg);
  z-index: 300;
  overflow-y: auto;
  padding: 2rem;
  flex-direction: column;
  align-items: center;
}
.exp-header {
  text-align: center;
  margin-bottom: 2rem;
  animation: fadeUp 0.5s both;
}
.exp-icon {
  font-size: 3rem;
  display: block;
  margin-bottom: 0.75rem;
  animation: float 3s ease-in-out infinite;
}
@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-6px); }
}
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
.exp-header h2 {
  font-family: var(--display-font);
  font-size: 1.75rem;
  color: var(--deep-color);
  margin-bottom: 0.5rem;
}
.exp-folder-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  background: color-mix(in srgb, var(--accent-color) 20%, transparent);
  border: 1px solid var(--accent-color);
  border-radius: 20px;
  padding: 0.25rem 0.85rem;
  font-size: 0.875rem;
  color: var(--deep-color);
}
.exp-stats {
  display: flex;
  gap: 1rem;
  margin: 1.5rem 0;
  flex-wrap: wrap;
  justify-content: center;
}
.exp-stat {
  background: var(--card-bg);
  border-radius: 8px;
  padding: 0.75rem 1.25rem;
  text-align: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  min-width: 90px;
}
.exp-stat-num {
  font-family: var(--display-font);
  font-size: 1.75rem;
  color: var(--accent-color);
  font-weight: 700;
}
.exp-stat-label { font-size: 0.75rem; opacity: 0.65; margin-top: 0.2rem; }
.exp-cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 1rem;
  max-width: 900px;
  width: 100%;
  margin: 0 auto 2rem;
}
.exp-card {
  background: var(--card-bg);
  border-radius: 8px;
  padding: 1rem 1.25rem;
  box-shadow: 0 1px 6px rgba(0,0,0,0.05);
  animation: fadeUp 0.5s both;
}
.exp-card-icon { font-size: 1.25rem; margin-bottom: 0.4rem; }
.exp-card h4 { font-size: 0.9rem; color: var(--deep-color); margin-bottom: 0.3rem; }
.exp-card p { font-size: 0.8rem; opacity: 0.7; line-height: 1.5; }
.exp-table {
  width: 100%;
  max-width: 600px;
  border-collapse: collapse;
  margin: 1.5rem auto;
  font-size: 0.85rem;
}
.exp-table td {
  padding: 0.6rem 0.75rem;
  border-bottom: 1px solid color-mix(in srgb, var(--accent-color) 20%, transparent);
}
.exp-badge {
  display: inline-block;
  background: color-mix(in srgb, var(--accent-color) 20%, transparent);
  border-radius: 4px;
  padding: 0.15rem 0.5rem;
  font-size: 0.75rem;
  color: var(--deep-color);
}
.exp-privacy {
  background: color-mix(in srgb, #4a90d9 15%, transparent);
  border: 1px solid color-mix(in srgb, #4a90d9 40%, transparent);
  border-radius: 8px;
  padding: 1rem 1.5rem;
  max-width: 600px;
  width: 100%;
  margin: 0 auto 2rem;
  font-size: 0.875rem;
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
}
.exp-actions {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  justify-content: center;
  margin-bottom: 2rem;
}
.btn-primary {
  background: var(--btn-bg);
  color: var(--btn-text);
  border: none;
  padding: 0.75rem 1.75rem;
  border-radius: 4px;
  cursor: pointer;
  font-family: var(--body-font);
  font-size: 1rem;
  font-weight: 500;
  transition: all 0.2s;
}
.btn-primary:hover { background: var(--btn-hover-bg); color: var(--btn-hover-text); }
.btn-secondary {
  background: none;
  color: var(--text-color);
  border: 1px solid color-mix(in srgb, var(--text-color) 30%, transparent);
  padding: 0.75rem 1.75rem;
  border-radius: 4px;
  cursor: pointer;
  font-family: var(--body-font);
  font-size: 1rem;
  transition: all 0.2s;
}
.btn-secondary:hover { border-color: var(--accent-color); color: var(--accent-color); }

/* ===================== ADMIN PANEL ===================== */
#admin-toggle-btn {
  background: var(--btn-bg);
  color: var(--btn-text);
  border: none;
  padding: 0.4rem 1rem;
  border-radius: 20px;
  cursor: pointer;
  font-family: var(--body-font);
  font-size: 0.8rem;
  font-weight: 500;
  transition: all 0.2s;
}
#admin-toggle-btn:hover { background: var(--accent-color); color: var(--deep-color); }
#admin-panel {
  position: fixed;
  top: 0; right: 0;
  width: var(--admin-w);
  height: 100vh;
  background: var(--card-bg);
  box-shadow: -4px 0 24px rgba(0,0,0,0.12);
  z-index: 200;
  display: flex;
  flex-direction: column;
  transform: translateX(100%);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  overflow: hidden;
}
#admin-panel.admin-open { transform: translateX(0); }

.admin-header {
  padding: 1rem 1.25rem;
  border-bottom: 1px solid color-mix(in srgb, var(--accent-color) 25%, transparent);
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}
.admin-header h3 { font-family: var(--display-font); font-size: 1.1rem; color: var(--deep-color); }
.admin-header-meta { display: flex; align-items: center; gap: 0.5rem; }
#settings-indicator {
  width: 8px; height: 8px;
  border-radius: 50%;
  cursor: help;
}
.indicator-green { background: #22c55e; }
.indicator-amber { background: #f59e0b; }

.admin-tabs {
  display: flex;
  border-bottom: 1px solid color-mix(in srgb, var(--accent-color) 25%, transparent);
  flex-shrink: 0;
  overflow-x: auto;
}
.admin-tab-btn {
  background: none;
  border: none;
  padding: 0.65rem 0.9rem;
  cursor: pointer;
  font-family: var(--body-font);
  font-size: 0.8rem;
  color: var(--text-color);
  opacity: 0.6;
  border-bottom: 2px solid transparent;
  white-space: nowrap;
  transition: all 0.2s;
}
.admin-tab-btn.tab-active { opacity: 1; border-bottom-color: var(--accent-color); color: var(--deep-color); font-weight: 600; }

.admin-tab-pane { display: none; overflow-y: auto; flex: 1; padding: 1.25rem; }
.admin-tab-pane.tab-active { display: block; }

.admin-form-group { margin-bottom: 1rem; }
.admin-form-group label {
  display: block;
  font-size: 0.78rem;
  font-weight: 600;
  color: var(--text-color);
  opacity: 0.7;
  margin-bottom: 0.3rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
}
.admin-form-group input,
.admin-form-group select,
.admin-form-group textarea {
  width: 100%;
  padding: 0.5rem 0.75rem;
  border: 1px solid color-mix(in srgb, var(--accent-color) 35%, transparent);
  border-radius: 4px;
  background: var(--page-bg);
  color: var(--text-color);
  font-family: var(--body-font);
  font-size: 0.875rem;
  transition: border-color 0.2s;
}
.admin-form-group input:focus,
.admin-form-group select:focus,
.admin-form-group textarea:focus {
  outline: none;
  border-color: var(--accent-color);
}
.color-row {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}
.color-row input[type="color"] {
  width: 36px; height: 36px;
  padding: 2px;
  border-radius: 4px;
  cursor: pointer;
  flex-shrink: 0;
}
.color-row input[type="text"] { flex: 1; }
.admin-section-title {
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--accent-color);
  margin: 1.25rem 0 0.6rem;
}
.admin-section-title:first-child { margin-top: 0; }

/* Theme grid */
#theme-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.75rem;
  margin-bottom: 1rem;
}
.theme-card {
  border: 2px solid color-mix(in srgb, var(--accent-color) 25%, transparent);
  border-radius: 8px;
  padding: 0.75rem;
  cursor: pointer;
  position: relative;
  transition: border-color 0.2s, transform 0.15s;
}
.theme-card:hover { border-color: var(--accent-color); transform: translateY(-1px); }
.theme-card--active { border-color: var(--accent-color); background: color-mix(in srgb, var(--accent-color) 8%, transparent); }
.theme-swatches { display: flex; gap: 4px; margin-bottom: 0.5rem; }
.theme-swatches span { width: 18px; height: 18px; border-radius: 3px; border: 1px solid rgba(0,0,0,0.1); flex-shrink: 0; }
.theme-info strong { font-size: 0.8rem; display: block; }
.theme-info small { font-size: 0.7rem; opacity: 0.6; }
.theme-active-badge {
  position: absolute; top: 6px; right: 6px;
  background: var(--accent-color);
  color: var(--deep-color);
  width: 18px; height: 18px;
  border-radius: 50%;
  font-size: 0.7rem;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700;
}
.theme-delete {
  position: absolute; top: 4px; right: 4px;
  background: #ef4444;
  color: white;
  border: none;
  width: 18px; height: 18px;
  border-radius: 50%;
  font-size: 0.8rem;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}

/* Fields tab */
#fields-list { display: flex; flex-direction: column; gap: 0.4rem; }
.field-row {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  padding: 0.5rem 0.6rem;
  background: var(--page-bg);
  border-radius: 4px;
  font-size: 0.875rem;
}
.drag-handle { cursor: grab; opacity: 0.4; font-size: 1rem; flex-shrink: 0; }
.drag-handle:active { cursor: grabbing; }
.field-label { flex: 1; text-transform: capitalize; }
.toggle { position: relative; display: inline-block; width: 36px; height: 20px; flex-shrink: 0; }
.toggle input { opacity: 0; width: 0; height: 0; }
.toggle-slider {
  position: absolute; inset: 0;
  background: color-mix(in srgb, var(--text-color) 20%, transparent);
  border-radius: 20px;
  cursor: pointer;
  transition: background 0.2s;
}
.toggle-slider::before {
  content: '';
  position: absolute;
  width: 14px; height: 14px;
  left: 3px; top: 3px;
  background: white;
  border-radius: 50%;
  transition: transform 0.2s;
}
.toggle input:checked + .toggle-slider { background: var(--accent-color); }
.toggle input:checked + .toggle-slider::before { transform: translateX(16px); }

/* Admin footer buttons */
.admin-footer {
  padding: 0.85rem 1.25rem;
  border-top: 1px solid color-mix(in srgb, var(--accent-color) 25%, transparent);
  display: flex;
  gap: 0.5rem;
  flex-shrink: 0;
}
.admin-footer button {
  flex: 1;
  padding: 0.55rem 0.5rem;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-family: var(--body-font);
  font-size: 0.8rem;
  font-weight: 600;
  transition: all 0.2s;
}
#admin-preview-btn { background: var(--accent-color); color: var(--deep-color); }
#admin-preview-btn:hover { filter: brightness(1.1); }
#admin-discard-btn { background: color-mix(in srgb, var(--text-color) 15%, transparent); color: var(--text-color); }
#admin-discard-btn:hover { background: color-mix(in srgb, var(--text-color) 25%, transparent); }
#admin-save-btn { background: var(--btn-bg); color: var(--btn-text); }
#admin-save-btn:hover { background: var(--btn-hover-bg); color: var(--btn-hover-text); }
.admin-settings-note {
  padding: 0.5rem 1.25rem;
  font-size: 0.72rem;
  opacity: 0.55;
  text-align: center;
  background: color-mix(in srgb, var(--accent-color) 8%, transparent);
  flex-shrink: 0;
}

/* Admin folder drop */
#admin-folder-drop {
  border: 2px dashed color-mix(in srgb, var(--accent-color) 50%, transparent);
  border-radius: 8px;
  padding: 1.5rem;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 0.875rem;
}
#admin-folder-drop:hover, #admin-folder-drop.drag-over {
  border-color: var(--accent-color);
  background: color-mix(in srgb, var(--accent-color) 8%, transparent);
}

/* ===================== TOAST ===================== */
#toast {
  position: fixed;
  bottom: 2rem;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--deep-color);
  color: var(--btn-text);
  padding: 0.7rem 1.5rem;
  border-radius: 20px;
  font-size: 0.875rem;
  opacity: 0;
  transition: opacity 0.3s, transform 0.3s;
  z-index: 9999;
  pointer-events: none;
  white-space: nowrap;
}
#toast.toast-show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ===================== CREATE THEME BTN ===================== */
#create-theme-btn {
  width: 100%;
  padding: 0.6rem;
  border: 2px dashed color-mix(in srgb, var(--accent-color) 50%, transparent);
  border-radius: 6px;
  background: none;
  color: var(--accent-color);
  cursor: pointer;
  font-family: var(--body-font);
  font-size: 0.85rem;
  font-weight: 600;
  transition: all 0.2s;
  margin-bottom: 1rem;
}
#create-theme-btn:hover { background: color-mix(in srgb, var(--accent-color) 10%, transparent); }

/* ===================== SCROLLBAR STYLING ===================== */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: color-mix(in srgb, var(--accent-color) 40%, transparent); border-radius: 3px; }

#theme-readonly-note {
  display: none;
  background: color-mix(in srgb, var(--accent-color) 12%, transparent);
  border: 1px solid color-mix(in srgb, var(--accent-color) 35%, transparent);
  border-radius: 6px;
  padding: 0.6rem 0.85rem;
  font-size: 0.78rem;
  color: var(--text-color);
  margin-bottom: 1rem;
}

  border-top: 1px solid color-mix(in srgb, var(--accent-color) 25%, transparent);
  padding-top: 1rem;
  margin-top: 0.5rem;
}
</style>
</head>
<body>

<!-- ===================== HEADER ===================== -->
<header id="site-header">
  <div id="store-name-display">Product Showcase</div>
  <div class="header-actions">
    <div class="view-toggle" id="view-toggle" style="display:none">
      <button class="view-btn active" id="view-grid-btn" title="Grid view">‚äû</button>
      <button class="view-btn" id="view-list-btn" title="List view">‚ò∞</button>
    </div>
    <!-- Admin button only in ?admin=1 mode -->
  </div>
</header>

<!-- ===================== HERO ===================== -->
<section id="hero">
  <h1 id="hero-title-display">Our Collection</h1>
  <p id="hero-sub-display">Discover something beautiful</p>
</section>

<!-- ===================== DROP ZONE ===================== -->
<div id="dropzone-wrap">
  <div id="dropzone">
    <span class="drop-icon">üóÇÔ∏è</span>
    <div class="drop-title">Drop your product folder here</div>
    <p class="drop-sub">or click to browse ‚Äî JPG, PNG, GIF, WebP, SVG, BMP, TIFF supported</p>
  </div>
  <div id="reload-notice">
    <p>üìÅ Previous folder remembered: <strong id="reload-folder-name">‚Äî</strong></p>
    <button id="reload-btn">Re-select same folder</button>
  </div>
</div>

<!-- ===================== MAIN CONTENT ===================== -->
<main id="main-content">
  <div id="product-grid" class="product-grid"></div>
  <div id="pagination"></div>
</main>

<!-- ===================== CONTACT FOOTER ===================== -->
<footer id="contact-footer">
  <span id="footer-tagline"></span>
  <!-- contact links injected by JS -->
</footer>

<!-- ===================== MODAL ===================== -->
<div id="modal-overlay">
  <div id="modal-box"></div>
</div>

<!-- ===================== EXPLAINER OVERLAY ===================== -->
<div id="explainer-overlay">
  <div class="exp-header">
    <span class="exp-icon">‚úÖ</span>
    <h2>Folder scanned ‚Äî ready to view</h2>
    <div class="exp-folder-badge">üìÅ <span id="exp-folder-name">‚Äî</span></div>
  </div>

  <div class="exp-stats">
    <div class="exp-stat">
      <div class="exp-stat-num" id="exp-img-count">0</div>
      <div class="exp-stat-label">Images</div>
    </div>
    <div class="exp-stat">
      <div class="exp-stat-num" id="exp-txt-count">0</div>
      <div class="exp-stat-label">Metadata .txt</div>
    </div>
    <div class="exp-stat">
      <div class="exp-stat-num" id="exp-total-count">0</div>
      <div class="exp-stat-label">Total files</div>
    </div>
    <div class="exp-stat">
      <div class="exp-stat-num" id="exp-skipped-count">0</div>
      <div class="exp-stat-label">Skipped</div>
    </div>
  </div>

  <div class="exp-cards">
    <div class="exp-card"><div class="exp-card-icon">üñºÔ∏è</div><h4>Images & Loading</h4><p>Files are read directly into browser memory via the File System Access API. Supported: JPG, PNG, GIF, WebP, TIFF, BMP, SVG. Never uploaded.</p></div>
    <div class="exp-card"><div class="exp-card-icon">üìÑ</div><h4>Product Metadata</h4><p>Add a .txt file with the same name as your image. Use key: / value pairs for title, price, description, and any custom fields.</p></div>
    <div class="exp-card"><div class="exp-card-icon">üíæ</div><h4>Settings File</h4><p>All settings are stored in settings.json beside this HTML file. Downloaded when you save from the admin panel.</p></div>
    <div class="exp-card"><div class="exp-card-icon">‚öôÔ∏è</div><h4>Admin Panel</h4><p>Hidden by default. Add ?admin=1 to the URL to reveal the admin button for customizing themes, fields, and contact info.</p></div>
    <div class="exp-card"><div class="exp-card-icon">üé®</div><h4>Theme System</h4><p>2 built-in themes: Editorial Warm and Brutalist Dark. Create and customize unlimited custom themes with full color, typography, and layout control.</p></div>
    <div class="exp-card"><div class="exp-card-icon">üîÅ</div><h4>Folder Auto-reload</h4><p>Your folder name is remembered. On your next visit, one click re-selects the same folder. Browser security requires user interaction each time.</p></div>
    <div class="exp-card"><div class="exp-card-icon">üîç</div><h4>Auto Field Detection</h4><p>All keys from all .txt files are auto-discovered. Toggle visibility on cards and drag to reorder ‚Äî all fields always show in the detail modal.</p></div>
    <div class="exp-card"><div class="exp-card-icon">üìû</div><h4>Contact Footer</h4><p>Add email, phone, WhatsApp, WeChat, Telegram, Instagram, or website links. Footer only appears when at least one field is set.</p></div>
    <div class="exp-card"><div class="exp-card-icon">üì°</div><h4>Network Requests</h4><p>Only Google Fonts is loaded externally. No analytics, no trackers. Fully offline capable once fonts are cached.</p></div>
  </div>

  <table class="exp-table">
    <tr><td>üñºÔ∏è</td><td>Product images & .txt</td><td>Browser memory (temporary)</td><td><span class="exp-badge">Memory only</span></td></tr>
    <tr><td>‚öôÔ∏è</td><td>Settings, themes, contact</td><td>settings.json on disk</td><td><span class="exp-badge">settings.json</span></td></tr>
    <tr><td>üì§</td><td>Your files & data</td><td>Never uploaded anywhere</td><td><span class="exp-badge">Never uploaded</span></td></tr>
    <tr><td>üåê</td><td>Fonts (Playfair & Jost)</td><td>Google Fonts CDN</td><td><span class="exp-badge">Google CDN</span></td></tr>
  </table>

  <div class="exp-privacy">
    üõ°Ô∏è
    <span>100% private. Self-contained HTML file. Images, prices, contact details never transmitted. Works fully offline once fonts are cached.</span>
  </div>

  <div class="exp-actions">
    <button class="btn-primary" id="exp-view-btn">View my products</button>
    <button class="btn-secondary" id="exp-back-btn">‚Üê Choose different folder</button>
  </div>
</div>

<!-- ===================== ADMIN PANEL ===================== -->
<div id="admin-panel">
  <div class="admin-header">
    <h3>‚öô Admin</h3>
    <div class="admin-header-meta">
      <span id="settings-indicator" class="indicator-amber" title="No settings.json ‚Äî using defaults"></span>
    </div>
  </div>

  <div class="admin-tabs">
    <button class="admin-tab-btn tab-active" data-tab="design">Design</button>
    <button class="admin-tab-btn" data-tab="theme">Theme</button>
    <button class="admin-tab-btn" data-tab="folder">Folder</button>
    <button class="admin-tab-btn" data-tab="fields">Fields</button>
    <button class="admin-tab-btn" data-tab="contact">Contact</button>
  </div>

  <!-- DESIGN TAB -->
  <div class="admin-tab-pane tab-active" id="tab-design">
    <div class="admin-form-group">
      <label>Store Name</label>
      <input type="text" id="admin-store-name" placeholder="Product Showcase" />
    </div>
    <div class="admin-form-group">
      <label>Page Heading</label>
      <input type="text" id="admin-hero-title" placeholder="Our Collection" />
    </div>
    <div class="admin-form-group">
      <label>Page Subtitle</label>
      <input type="text" id="admin-hero-sub" placeholder="Discover something beautiful" />
    </div>
  </div>

  <!-- THEME TAB -->
  <div class="admin-tab-pane" id="tab-theme">
    <div id="theme-grid"></div>
    <button id="create-theme-btn">+ Create New Theme</button>

    <div id="theme-editor-wrap">
      <div class="admin-section-title">Customize Theme</div>
      <div id="theme-readonly-note">üîí Built-in themes are read-only. Click <strong>+ Create New Theme</strong> to inherit and customize.</div>
      <div id="theme-editor">
        <div class="admin-form-group">
          <label>Theme Name</label>
          <input type="text" id="te-name" />
        </div>

        <div class="admin-section-title">Layout</div>
        <div class="admin-form-group"><label>Columns (2-6)</label><input type="number" id="te-columns" min="2" max="6" /></div>
        <div class="admin-form-group"><label>Items per Page</label>
          <select id="te-itemsPerPage">
            <option>6</option><option>9</option><option>12</option><option>16</option><option>18</option><option>24</option><option>All</option>
          </select>
        </div>
        <div class="admin-form-group"><label>Gap (rem)</label><input type="number" id="te-gap" min="0" max="4" step="0.25" /></div>
        <div class="admin-form-group"><label>Card Border Radius (px)</label><input type="number" id="te-cardRadius" min="0" max="32" /></div>
        <div class="admin-form-group"><label>Image Aspect Ratio</label>
          <select id="te-aspectRatio">
            <option value="1/1">1:1 Square</option>
            <option value="4/3">4:3 Landscape</option>
            <option value="3/4">3:4 Portrait</option>
            <option value="16/9">16:9 Wide</option>
          </select>
        </div>

        <div class="admin-section-title">Colors</div>
        <div class="admin-form-group"><label>Page Background</label><div class="color-row"><input type="color" id="te-pageBg-picker" /><input type="text" id="te-pageBg" /></div></div>
        <div class="admin-form-group"><label>Card Background</label><div class="color-row"><input type="color" id="te-cardBg-picker" /><input type="text" id="te-cardBg" /></div></div>
        <div class="admin-form-group"><label>Text Color</label><div class="color-row"><input type="color" id="te-textColor-picker" /><input type="text" id="te-textColor" /></div></div>
        <div class="admin-form-group"><label>Accent Color</label><div class="color-row"><input type="color" id="te-accentColor-picker" /><input type="text" id="te-accentColor" /></div></div>
        <div class="admin-form-group"><label>Deep/Heading Color</label><div class="color-row"><input type="color" id="te-deepColor-picker" /><input type="text" id="te-deepColor" /></div></div>
        <div class="admin-form-group"><label>Button Background</label><div class="color-row"><input type="color" id="te-btnBg-picker" /><input type="text" id="te-btnBg" /></div></div>
        <div class="admin-form-group"><label>Button Text</label><div class="color-row"><input type="color" id="te-btnText-picker" /><input type="text" id="te-btnText" /></div></div>
        <div class="admin-form-group"><label>Button Hover Bg</label><div class="color-row"><input type="color" id="te-btnHoverBg-picker" /><input type="text" id="te-btnHoverBg" /></div></div>
        <div class="admin-form-group"><label>Button Hover Text</label><div class="color-row"><input type="color" id="te-btnHoverText-picker" /><input type="text" id="te-btnHoverText" /></div></div>
        <div class="admin-form-group"><label>Footer Background</label><div class="color-row"><input type="color" id="te-footerBg-picker" /><input type="text" id="te-footerBg" /></div></div>
        <div class="admin-form-group"><label>Footer Text</label><div class="color-row"><input type="color" id="te-footerText-picker" /><input type="text" id="te-footerText" /></div></div>

        <div class="admin-section-title">Typography</div>
        <div class="admin-form-group"><label>Display Font</label><input type="text" id="te-displayFont" placeholder="'Playfair Display', serif" /></div>
        <div class="admin-form-group"><label>Body Font</label><input type="text" id="te-bodyFont" placeholder="'Jost', sans-serif" /></div>
        <div class="admin-form-group"><label>Card Title Size (rem)</label><input type="number" id="te-titleSize" step="0.05" /></div>
        <div class="admin-form-group"><label>Description Size (rem)</label><input type="number" id="te-descSize" step="0.05" /></div>
        <div class="admin-form-group"><label>Description Line Clamp</label><input type="number" id="te-descClamp" min="1" max="10" /></div>

        <div class="admin-section-title">Modal</div>
        <div class="admin-form-group"><label>Modal Style</label>
          <select id="te-modalStyle"><option value="side-by-side">Side-by-side</option><option value="top-down">Top-down</option></select>
        </div>
        <div class="admin-form-group"><label>Modal Width (px or %)</label><input type="text" id="te-modalWidth" /></div>
        <div class="admin-form-group"><label>Modal Height (vh or %)</label><input type="text" id="te-modalHeight" /></div>
        <div class="admin-form-group"><label>Modal Title Size (rem)</label><input type="number" id="te-modalTitleSize" step="0.05" /></div>
        <div class="admin-form-group"><label>Modal Description Size (rem)</label><input type="number" id="te-modalDescSize" step="0.05" /></div>
        <div class="admin-form-group"><label>Modal Image Width % <small style="opacity:0.6">(side-by-side)</small></label><input type="number" id="te-modalImgWidth" min="20" max="80" /></div>
        <div class="admin-form-group"><label>Modal Image Height vh <small style="opacity:0.6">(top-down)</small></label><input type="number" id="te-modalImgHeight" min="20" max="80" /></div>

        <div class="admin-section-title">Footer</div>
        <div class="admin-form-group"><label>Footer Font Size (rem)</label><input type="number" id="te-footerFontSize" step="0.05" /></div>
        <div class="admin-form-group"><label>Footer Tagline</label><input type="text" id="te-footerTagline" /></div>
      </div>
    </div>
  </div>

  <!-- FOLDER TAB -->
  <div class="admin-tab-pane" id="tab-folder">
    <div class="admin-form-group">
      <label>Current Folder</label>
      <div style="display:flex;align-items:center;gap:0.5rem;">
        <span id="admin-current-folder" style="font-size:0.875rem;flex:1">None</span>
        <button id="admin-folder-clear" style="background:none;border:1px solid color-mix(in srgb, var(--text-color) 30%, transparent);border-radius:4px;padding:0.25rem 0.5rem;cursor:pointer;font-size:0.8rem;color:var(--text-color)">√ó Clear</button>
      </div>
    </div>
    <div id="admin-folder-drop" style="margin-bottom:1.5rem;">
      <div style="font-size:1.5rem;margin-bottom:0.4rem">üìÇ</div>
      <div style="font-weight:600;margin-bottom:0.25rem">Drop folder here</div>
      <div style="font-size:0.8rem;opacity:0.6">or click to browse</div>
    </div>
    <div class="admin-section-title">Session Info</div>
    <div style="font-size:0.85rem;display:flex;flex-direction:column;gap:0.4rem;">
      <div>Folder: <strong id="session-folder">None</strong></div>
      <div>Products: <strong id="session-count">0</strong></div>
    </div>
  </div>

  <!-- FIELDS TAB -->
  <div class="admin-tab-pane" id="tab-fields">
    <div class="admin-form-group" style="display:flex;align-items:center;justify-content:space-between;">
      <label style="margin:0">Show description on cards</label>
      <label class="toggle"><input type="checkbox" id="admin-show-desc" checked><span class="toggle-slider"></span></label>
    </div>
    <div class="admin-section-title" style="margin-top:1rem">Field Visibility & Order</div>
    <div id="fields-list"></div>
    <p style="font-size:0.75rem;opacity:0.5;margin-top:0.75rem">Drag ‚†ø to reorder. All fields always show in the product modal.</p>
  </div>

  <!-- CONTACT TAB -->
  <div class="admin-tab-pane" id="tab-contact">
    <div class="admin-form-group"><label>Email</label><input type="email" id="admin-email" placeholder="hello@example.com" /></div>
    <div class="admin-form-group"><label>Phone</label><input type="tel" id="admin-phone" placeholder="+1 555 000 0000" /></div>
    <div class="admin-form-group"><label>WhatsApp (with country code)</label><input type="text" id="admin-whatsapp" placeholder="15550000000" /></div>
    <div class="admin-form-group"><label>WeChat ID</label><input type="text" id="admin-wechat" placeholder="wechat_id" /></div>
    <div class="admin-form-group"><label>Telegram</label><input type="text" id="admin-telegram" placeholder="username" /></div>
    <div class="admin-form-group"><label>Instagram</label><input type="text" id="admin-instagram" placeholder="username" /></div>
    <div class="admin-form-group"><label>Website</label><input type="url" id="admin-website" placeholder="https://example.com" /></div>
  </div>

  <div class="admin-footer">
    <button id="admin-preview-btn">üëÅ Preview</button>
    <button id="admin-discard-btn">Discard</button>
    <button id="admin-save-btn">üíæ Save</button>
  </div>
  <div class="admin-settings-note">Saves to <strong>settings.json</strong> ‚Äî download and replace beside this HTML file.</div>
</div>

<!-- ===================== TOAST ===================== -->
<div id="toast"></div>

<!-- ===================== MAIN SCRIPT ===================== -->
<script type="module">
import { applyTheme, buildThemeGrid, populateThemeEditor, readThemeEditor } from './theme.js';
import { initModal, openModal } from './modal.js';
import { initDisplay, setViewMode, setPage } from './product_display.js';
import { showExplainer, hideExplainer } from './explainer.js';
import { initAdmin, updateFieldsTab, updateSessionInfo, showToast } from './admin.js';

// =========================================================
// STATE
// =========================================================
const DEFAULT_CONFIG = {
  storeName: 'Product Showcase',
  heroTitle: 'Our Collection',
  heroSub: 'Discover something beautiful',
  currentTheme: 'editorial',
  themes: {
    editorial: {
      name: 'Editorial Warm',
      pageBg: '#f7f4ef', cardBg: '#ffffff', textColor: '#3d2b1a',
      accentColor: '#c8a97e', deepColor: '#1a0f05',
      btnBg: '#3d2b1a', btnText: '#f7f4ef', btnHoverBg: '#c8a97e', btnHoverText: '#1a0f05',
      footerBg: '#3d2b1a', footerText: '#f7f4ef',
      displayFont: "'Playfair Display', serif", bodyFont: "'Jost', sans-serif",
      titleSize: '1.05', descSize: '0.875', descClamp: '2',
      columns: '3', gap: '1.5', itemsPerPage: '12', cardRadius: '4', aspectRatio: '1/1',
      modalStyle: 'side-by-side', modalWidth: '860px', modalHeight: '90vh',
      modalTitleSize: '1.75', modalDescSize: '1', modalImgWidth: '48', modalImgHeight: '50',
      footerFontSize: '0.875', footerTagline: ''
    },
    noir: {
      name: 'Noir Elegance',
      pageBg: '#0f0f13', cardBg: '#1a1a22', textColor: '#c8c0b4',
      accentColor: '#b89a6a', deepColor: '#f0e8d8',
      btnBg: '#b89a6a', btnText: '#0f0f13', btnHoverBg: '#f0e8d8', btnHoverText: '#0f0f13',
      footerBg: '#0a0a0d', footerText: '#b89a6a',
      displayFont: "'Cormorant Garamond', serif", bodyFont: "'Jost', sans-serif",
      titleSize: '1.1', descSize: '0.875', descClamp: '2',
      columns: '3', gap: '1.25', itemsPerPage: '12', cardRadius: '2', aspectRatio: '3/4',
      modalStyle: 'side-by-side', modalWidth: '880px', modalHeight: '90vh',
      modalTitleSize: '2', modalDescSize: '1', modalImgWidth: '50', modalImgHeight: '50',
      footerFontSize: '0.875', footerTagline: ''
    }
  },
  showDesc: true, email: '', phone: '', whatsapp: '', wechat: '',
  telegram: '', instagram: '', website: '', folderName: '',
  fieldVis: { title: true, price: true, description: true },
  fieldOrder: ['title', 'price', 'description']
};

let config = JSON.parse(JSON.stringify(DEFAULT_CONFIG));
let savedConfig = JSON.parse(JSON.stringify(DEFAULT_CONFIG));
let products = [];
let isAdmin = new URLSearchParams(location.search).has('admin');

// =========================================================
// BOOT
// =========================================================
async function boot() {
  await loadSettings();
  applyThemeFromConfig();
  updateDisplay();
  if (isAdmin) setupAdminMode();
  setupDropzone();
  setupViewToggle();
  initModal();

  // Check folder memory
  if (config.folderName) {
    document.getElementById('reload-notice').style.display = 'block';
    document.getElementById('reload-folder-name').textContent = config.folderName;
    document.getElementById('reload-btn').onclick = () => triggerFolderPicker();
  }
}

async function loadSettings() {
  try {
    const res = await fetch('./settings.json?t=' + Date.now());
    if (!res.ok) throw new Error('not found');
    const data = await res.json();
    config = deepMerge(config, data);
    config._loaded = true;
    savedConfig = JSON.parse(JSON.stringify(config));
  } catch {
    config._loaded = false;
  }
}

function deepMerge(target, source) {
  const out = { ...target };
  for (const key of Object.keys(source)) {
    if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
      out[key] = deepMerge(target[key] || {}, source[key]);
    } else {
      out[key] = source[key];
    }
  }
  return out;
}

// =========================================================
// DISPLAY UPDATES
// =========================================================
function applyThemeFromConfig() {
  const theme = config.themes[config.currentTheme] || config.themes.editorial;
  applyTheme(theme);
}

function updateDisplay() {
  document.getElementById('store-name-display').textContent = config.storeName || 'Product Showcase';
  document.getElementById('hero-title-display').textContent = config.heroTitle || 'Our Collection';
  document.getElementById('hero-sub-display').textContent = config.heroSub || 'Discover something beautiful';
  renderContactFooter();
}

function renderContactFooter() {
  const footer = document.getElementById('contact-footer');
  const theme = config.themes[config.currentTheme] || {};
  footer.style.background = theme.footerBg || '';
  footer.style.color = theme.footerText || '';
  footer.style.fontSize = (theme.footerFontSize || '0.875') + 'rem';

  const taglineEl = document.getElementById('footer-tagline');
  taglineEl.textContent = theme.footerTagline || '';

  const links = [];
  if (config.email) links.push(`<a href="mailto:${config.email}">‚úâ Email</a>`);
  if (config.phone) links.push(`<a href="tel:${config.phone}">üìû ${config.phone}</a>`);
  if (config.whatsapp) links.push(`<a href="https://wa.me/${config.whatsapp}" target="_blank">üí¨ WhatsApp</a>`);
  if (config.wechat) links.push(`<span style="cursor:pointer" onclick="navigator.clipboard.writeText('${config.wechat}');alert('WeChat ID copied!')">üíö WeChat</span>`);
  if (config.telegram) links.push(`<a href="https://t.me/${config.telegram}" target="_blank">‚úà Telegram</a>`);
  if (config.instagram) links.push(`<a href="https://instagram.com/${config.instagram}" target="_blank">üì∏ Instagram</a>`);
  if (config.website) links.push(`<a href="${config.website}" target="_blank">üåê Website</a>`);

  // Remove old dynamic links
  footer.querySelectorAll('.contact-link, .footer-sep').forEach(el => el.remove());

  if (links.length) {
    links.forEach((html, i) => {
      const span = document.createElement('span');
      span.className = 'contact-link';
      span.innerHTML = html;
      footer.appendChild(span);
      if (i < links.length - 1) {
        const sep = document.createElement('span');
        sep.className = 'footer-sep';
        sep.textContent = ' ¬∑ ';
        footer.appendChild(sep);
      }
    });
    footer.classList.add('footer-visible');
  } else {
    footer.classList.remove('footer-visible');
  }
}

// =========================================================
// FOLDER LOADING
// =========================================================
const IMAGE_EXTS = ['jpg','jpeg','png','gif','webp','tiff','tif','bmp','svg'];

async function loadFolder(dirHandle) {
  const imageFiles = [];
  const txtFiles = {};
  let totalFiles = 0;
  let skipped = 0;

  // Recursively scan
  async function scan(handle, prefix) {
    for await (const [name, entry] of handle.entries()) {
      if (entry.kind === 'file') {
        totalFiles++;
        const ext = name.split('.').pop().toLowerCase();
        if (IMAGE_EXTS.includes(ext)) {
          imageFiles.push({ name, entry, prefix });
        } else if (ext === 'txt') {
          txtFiles[(prefix ? prefix + '/' : '') + name] = entry;
        } else {
          skipped++;
        }
      } else if (entry.kind === 'directory') {
        await scan(entry, (prefix ? prefix + '/' : '') + name);
      }
    }
  }

  await scan(dirHandle, '');

  // Sort naturally
  imageFiles.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));

  // Build products
  const allFieldKeys = new Set(['title','price','description']);
  const prods = [];

  for (const { name, entry, prefix } of imageFiles) {
    const file = await entry.getFile();
    const src = URL.createObjectURL(file);
    const baseName = name.replace(/\.[^.]+$/, '');
    const txtKey = (prefix ? prefix + '/' : '') + baseName + '.txt';
    const txtEntry = txtFiles[txtKey];

    const product = { _src: src, _filename: name };
    if (txtEntry) {
      const txtFile = await txtEntry.getFile();
      const text = await txtFile.text();
      const parsed = parseTxt(text);
      Object.assign(product, parsed);
      Object.keys(parsed).forEach(k => allFieldKeys.add(k));
    }
    // Derive title from filename only when metafile has no title field
    if (!product.title) {
      product.title = baseName.replace(/_/g, ' ').replace(/-/g, ' ');
    }
    prods.push(product);
  }

  products = prods;
  config.folderName = dirHandle.name;

  // Update field order/vis with newly discovered fields
  const newFields = [...allFieldKeys].filter(f => !config.fieldOrder.includes(f));
  newFields.forEach(f => {
    config.fieldOrder.push(f);
    if (config.fieldVis[f] === undefined) config.fieldVis[f] = true;
  });

  // Update session count
  const sessionCount = document.getElementById('session-count');
  if (sessionCount) sessionCount.textContent = products.length;
  updateSessionInfo(config);

  if (isAdmin) updateFieldsTab([...allFieldKeys], config);

  showExplainer(
    dirHandle.name, imageFiles.length, Object.keys(txtFiles).length,
    totalFiles, skipped,
    () => showProducts(),
    () => showDropzone()
  );
}

function parseTxt(text) {
  const result = {};
  const lines = text.split('\n');
  let currentKey = null;
  let valueLines = [];

  const saveCurrentKey = () => {
    if (currentKey !== null) {
      const val = valueLines.join('\n').trim();
      if (val) result[currentKey] = val; // only store non-empty values
    }
  };

  for (const line of lines) {
    // A key is a line whose only content is a word ending with ':' (optional trailing whitespace)
    const keyMatch = line.match(/^([a-zA-Z0-9_ ]+):\s*$/);
    if (keyMatch) {
      saveCurrentKey();
      currentKey = keyMatch[1].trim().toLowerCase();
      valueLines = [];
    } else if (currentKey !== null) {
      valueLines.push(line);
    }
  }
  saveCurrentKey(); // flush last key
  return result;
}

async function triggerFolderPicker() {
  try {
    const dirHandle = await window.showDirectoryPicker();
    await loadFolder(dirHandle);
  } catch (e) {
    if (e.name !== 'AbortError') showToast('Could not open folder: ' + e.message);
  }
}

// =========================================================
// DROP ZONE
// =========================================================
function setupDropzone() {
  const dz = document.getElementById('dropzone');

  dz.addEventListener('click', triggerFolderPicker);

  dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('drag-over'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('drag-over'));
  dz.addEventListener('drop', async (e) => {
    e.preventDefault();
    dz.classList.remove('drag-over');
    const item = e.dataTransfer.items[0];
    if (item?.kind === 'file') {
      const entry = item.getAsFileSystemHandle ? await item.getAsFileSystemHandle() : null;
      if (entry?.kind === 'directory') {
        await loadFolder(entry);
      } else {
        showToast('Please drop a folder, not a file.');
      }
    }
  });
}

// =========================================================
// VIEW TOGGLING
// =========================================================
function setupViewToggle() {
  document.getElementById('view-grid-btn').addEventListener('click', () => {
    document.getElementById('view-grid-btn').classList.add('active');
    document.getElementById('view-list-btn').classList.remove('active');
    setViewMode('grid');
  });
  document.getElementById('view-list-btn').addEventListener('click', () => {
    document.getElementById('view-list-btn').classList.add('active');
    document.getElementById('view-grid-btn').classList.remove('active');
    setViewMode('list');
  });
}

// =========================================================
// SCREEN STATES
// =========================================================
function showDropzone() {
  document.getElementById('dropzone-wrap').style.display = 'flex';
  document.getElementById('main-content').style.display = 'none';
  document.getElementById('view-toggle').style.display = 'none';
}

function showProducts() {
  document.getElementById('dropzone-wrap').style.display = 'none';
  document.getElementById('main-content').style.display = 'block';
  document.getElementById('view-toggle').style.display = 'flex';
  initDisplay(products, config);
}

// =========================================================
// ADMIN MODE
// =========================================================
function setupAdminMode() {
  // Inject admin toggle button
  const btn = document.createElement('button');
  btn.id = 'admin-toggle-btn';
  btn.textContent = '‚öô Admin';
  document.querySelector('.header-actions').appendChild(btn);

  initAdmin(config, {
    onSave: () => { savedConfig = JSON.parse(JSON.stringify(config)); },
    onPreview: () => { applyThemeFromConfig(); updateDisplay(); if (products.length) initDisplay(products, config); },
    onDiscard: () => {
      config = JSON.parse(JSON.stringify(savedConfig));
      applyThemeFromConfig();
      updateDisplay();
      if (products.length) initDisplay(products, config);
    },
    rerender: () => {
      applyThemeFromConfig();
      updateDisplay();
      if (products.length) initDisplay(products, config);
    },
    onFolderLoad: async (dirHandle) => {
      await loadFolder(dirHandle);
    }
  });
}

// =========================================================
// START
// =========================================================
boot();
</script>
</body>
</html>
